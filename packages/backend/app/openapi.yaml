openapi: 3.0.3
info:
  title: FinMind API
  version: 0.1.0
  description: API for budgeting, bills, reminders and insights
servers:
  - url: http://localhost:8000
tags:
  - name: Auth
  - name: Categories
  - name: Expenses
  - name: Bills
  - name: Reminders
  - name: Insights
paths:
  /auth/register:
    post:
      summary: Register user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
            example:
              email: user@example.com
              password: secret123
      responses:
        '201': { description: Created }
        '400':
          description: Email already used or missing fields
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              example: { error: "email already used" }
  /auth/login:
    post:
      summary: Login
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
            example:
              email: user@example.com
              password: secret123
      responses:
        '200':
          description: Tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
              example:
                access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                refresh_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              example: { error: "invalid credentials" }
  /auth/refresh:
    post:
      summary: Refresh access token
      tags: [Auth]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: New access token
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token: { type: string }
              example:
                access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '401':
          description: Missing/invalid refresh token
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              example: { error: "Missing Authorization Header" }

  /categories:
    get:
      summary: List categories
      tags: [Categories]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: List of categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'
              example:
                - { id: 1, name: Groceries }
                - { id: 2, name: Utilities }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    post:
      summary: Create category
      tags: [Categories]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name: { type: string }
            example: { name: Subscriptions }
      responses:
        '201': { description: Created }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '409':
          description: Already exists
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              example: { error: "category already exists" }

  /expenses:
    get:
      summary: List expenses
      tags: [Expenses]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: List of expenses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Expense'
              example:
                - { id: 10, amount: 12.5, currency: USD, category_id: 1, notes: Lunch, spent_at: 2025-08-10 }
                - { id: 11, amount: 49.0, currency: USD, category_id: 2, notes: "", spent_at: 2025-08-09 }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    post:
      summary: Create expense
      tags: [Expenses]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewExpense'
            example:
              amount: 12.5
              currency: USD
              category_id: 1
              notes: Lunch
              spent_at: 2025-08-10
      responses:
        '201': { description: Created }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /bills:
    get:
      summary: List bills
      tags: [Bills]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: List of bills
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Bill'
              example:
                - { id: 3, name: Internet, amount: 49.99, currency: USD, next_due_date: 2025-08-15, cadence: MONTHLY, channel_email: true, channel_whatsapp: false }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    post:
      summary: Create bill
      tags: [Bills]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewBill'
            example:
              name: Internet
              amount: 49.99
              currency: USD
              next_due_date: 2025-08-15
              cadence: MONTHLY
              channel_email: true
              channel_whatsapp: false
      responses:
        '201': { description: Created }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /bills/{billId}/pay:
    post:
      summary: Mark bill paid
      tags: [Bills]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: billId
          required: true
          schema: { type: integer }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
              example: { message: updated }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /reminders:
    get:
      summary: List reminders
      tags: [Reminders]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: List of reminders
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reminder'
              example:
                - { id: 6, message: Pay credit card, send_at: 2025-08-11T10:00:00Z, sent: false, channel: email }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    post:
      summary: Create reminder
      tags: [Reminders]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NewReminder'
            example:
              message: Pay credit card
              send_at: 2025-08-11T10:00:00Z
              channel: email
      responses:
        '201': { description: Created }
        '400':
          description: Validation error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /reminders/run:
    post:
      summary: Process due reminders
      tags: [Reminders]
      security: [{ bearerAuth: [] }]
      responses:
        '200': { description: Processed count }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /insights/budget-suggestion:
    get:
      summary: Get dynamic budget suggestion based on 3-6 months of spending data
      tags: [Insights]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: month
          schema: { type: string, pattern: '^\d{4}-\d{2}$' }
          description: Target month (YYYY-MM). Defaults to current month.
          example: "2026-02"
        - in: query
          name: months
          schema: { type: integer, minimum: 3, maximum: 6 }
          description: Number of months to look back (3-6). Defaults to 6.
          example: 6
      responses:
        '200':
          description: Dynamic budget suggestion with confidence score
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetSuggestion'
              example:
                month: "2026-02"
                suggested_total: 1425.50
                breakdown:
                  needs: 712.75
                  wants: 427.65
                  savings: 285.10
                confidence:
                  score: 0.78
                  label: high
                  months_analyzed: 4
                spending_trend:
                  direction: increasing
                  change_pct: 5.3
                category_suggestions:
                  - category_id: 1
                    category_name: Food
                    suggested_limit: 475.00
                    average_spending: 500.00
                    trend_pct: 3.2
                    trend_direction: increasing
                    months_with_data: 4
                    monthly_history:
                      "2025-08": 480
                      "2025-09": 490
                      "2025-10": 510
                      "2025-11": 520
                data_range:
                  months_requested: 6
                  months_with_data: 4
                  oldest_month: "2025-08"
                  newest_month: "2025-11"
                monthly_totals:
                  "2025-08": 1350
                  "2025-09": 1400
                  "2025-10": 1450
                  "2025-11": 1500
                method: heuristic
        '400':
          description: Invalid month format
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
              example: { error: "invalid month, expected YYYY-MM" }
        '401':
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Error:
      type: object
      properties:
        error: { type: string }
      example: { error: "invalid credentials" }
    TokenPair:
      type: object
      properties:
        access_token: { type: string }
        refresh_token: { type: string }
    Category:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
    Expense:
      type: object
      properties:
        id: { type: integer }
        amount: { type: number, format: float }
        currency: { type: string }
        category_id: { type: integer }
        notes: { type: string, nullable: true }
        spent_at: { type: string, format: date }
    NewExpense:
      type: object
      required: [amount]
      properties:
        amount: { type: number, format: float }
        currency: { type: string, default: USD }
        category_id: { type: integer, nullable: true }
        notes: { type: string, nullable: true }
        spent_at: { type: string, format: date, nullable: true }
    Bill:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        amount: { type: number, format: float }
        currency: { type: string }
        next_due_date: { type: string, format: date }
        cadence: { type: string, enum: [WEEKLY, MONTHLY, YEARLY, ONCE] }
        channel_email: { type: boolean }
        channel_whatsapp: { type: boolean }
    NewBill:
      type: object
      required: [name, amount, next_due_date]
      properties:
        name: { type: string }
        amount: { type: number, format: float }
        currency: { type: string, default: USD }
        next_due_date: { type: string, format: date }
        cadence: { type: string, enum: [WEEKLY, MONTHLY, YEARLY, ONCE], default: MONTHLY }
        channel_email: { type: boolean, default: true }
        channel_whatsapp: { type: boolean, default: false }
    Reminder:
      type: object
      properties:
        id: { type: integer }
        message: { type: string }
        send_at: { type: string, format: date-time }
        sent: { type: boolean }
        channel: { type: string, enum: [email, whatsapp] }
    NewReminder:
      type: object
      required: [message, send_at]
      properties:
        message: { type: string }
        send_at: { type: string, format: date-time }
        channel: { type: string, enum: [email, whatsapp], default: email }
    BudgetSuggestion:
      type: object
      properties:
        month: { type: string, description: "Target month YYYY-MM" }
        suggested_total: { type: number, format: float }
        breakdown:
          type: object
          properties:
            needs: { type: number }
            wants: { type: number }
            savings: { type: number }
        confidence:
          $ref: '#/components/schemas/ConfidenceScore'
        spending_trend:
          type: object
          properties:
            direction: { type: string, enum: [increasing, decreasing, stable] }
            change_pct: { type: number }
        category_suggestions:
          type: array
          items:
            $ref: '#/components/schemas/CategorySuggestion'
        data_range:
          type: object
          properties:
            months_requested: { type: integer }
            months_with_data: { type: integer }
            oldest_month: { type: string }
            newest_month: { type: string }
        monthly_totals:
          type: object
          additionalProperties: { type: number }
        method: { type: string, enum: [heuristic, heuristic_default, openai] }
        tips:
          type: array
          items: { type: string }
    ConfidenceScore:
      type: object
      properties:
        score: { type: number, minimum: 0, maximum: 1, description: "0.0 to 1.0" }
        label: { type: string, enum: [no_data, low, medium, high, very_high] }
        months_analyzed: { type: integer }
    CategorySuggestion:
      type: object
      properties:
        category_id: { type: integer, nullable: true }
        category_name: { type: string }
        suggested_limit: { type: number }
        average_spending: { type: number }
        trend_pct: { type: number }
        trend_direction: { type: string, enum: [increasing, decreasing, stable] }
        months_with_data: { type: integer }
        monthly_history:
          type: object
          additionalProperties: { type: number }
